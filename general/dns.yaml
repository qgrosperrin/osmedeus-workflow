name: dns
desc: Scanning for DNS records and ASN information

report:
  final:
    - "{{Output}}/dns/dns-records-{{Workspace}}.txt"
    - "{{Output}}/dns/dns-asn-{{Workspace}}.txt"
    - "{{Output}}/dns/asn-whois-details-{{Workspace}}.txt"

pre_run:
  - CreateFolder("{{Output}}/dns/")

params:
  - subdomainFile: "{{Output}}/subdomain/final-{{Workspace}}.txt"
  - dnsThreads: "100"
  - recordTypes: "-mx -txt"
  - providerConfig: "{{Data}}/external-configs/dnsx-providers.yaml"

steps:
  - required:
      - "{{Binaries}}/dnsx"
      - "whois" 
    
    commands:
      - "cat {{subdomainFile}} | {{Binaries}}/dnsx -silent {{recordTypes}} -resp -no-color -t {{dnsThreads}} -o {{Output}}/dns/dns-records-{{Workspace}}.txt"
      - "set -a && source {{providerConfig}} && set +a && cat {{subdomainFile}} | {{Binaries}}/dnsx -silent -asn -t {{dnsThreads}} -no-color -o {{Output}}/dns/dns-asn-{{Workspace}}.txt"
      - "grep -oE 'AS[0-9]+' {{Output}}/dns/dns-asn-{{Workspace}}.txt | sort -u | while read asn; do echo $asn; whois $asn | grep -iE '^(as-name|asname|org-name|orgname|org:|netname|country):' | head -n 10; echo '---'; sleep 3; done >> {{Output}}/dns/asn-whois-details-{{Workspace}}.txt"