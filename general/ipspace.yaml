name: ipspace
desc: Discovery IP Space of the target

report:
  final:
    - "{{Output}}/ipspace/{{Workspace}}-ip.txt"
    - "{{Output}}/ipspace/{{Workspace}}-range.txt"
    - "{{Workspace}}-ipspace-summary.txt"
    - "{{Output}}/ipspace/{{Workspace}}-noncdn.txt"
    - "{{Output}}/ipspace/{{Workspace}}-related.txt"
    - "{{Storages}}/summary/{{Workspace}}/ipspace-{{Workspace}}.txt"

params:
  - ipTimeout: '2h'
  - ipFile: '{{Output}}/ipspace/{{Workspace}}-ip.txt'
  - asnFile: '{{Output}}/dns/dns-asn-{{Workspace}}.txt'
  - providerConfig: "{{Data}}/external-configs/projectdiscovery-provider.yaml"
pre_run:
  - CreateFolder("{{Output}}/ipspace")

steps:
  # check with exactly domain first
  - required:
      - "{{Binaries}}/metabigor"
      - "{{Binaries}}/asnmap"

    commands:
      - "set -a && source {{providerConfig}} && set +a && grep -oE 'AS[0-9]+' {{asnFile}} | sort -u | {{Binaries}}/asnmap -silent -o {{Output}}/ipspace/{{Workspace}}-range.txt"
      - "set -a && source {{providerConfig}} && set +a && cat {{ipFile}} | {{Binaries}}/metabigor ipc --json -o {{Output}}/ipspace/{{Workspace}}-ipspace-summary.txt >/dev/null 2>&1"
    scripts:
      - SortU('{{Output}}/ipspace/{{Workspace}}-range.txt')

  # join results
  - scripts:
      - Append("{{Output}}/ipspace/{{Workspace}}-ipspace.txt", "{{Output}}/ipspace/{{Workspace}}-range.txt")
      - Append("{{Output}}/ipspace/{{Workspace}}-ipspace.txt", "{{ipFile}}")
      - SortU("{{Output}}/ipspace/{{Workspace}}-ipspace.txt")

  # strip CDN IP first
  - required:
      - "{{ipFile}}"
      - "{{Binaries}}/cdnstrip"
    commands:
      - "cat {{ipFile}} | timeout -k 1m {{ipTimeout}} {{Binaries}}/cdnstrip -cdn {{Output}}/ipspace/{{Workspace}}-cdn.txt -n {{Output}}/ipspace/{{Workspace}}-noncdn.txt"

  # in case strip CDN fail
  - conditions:
      - "FileLength('{{Output}}/ipspace/{{Workspace}}-noncdn.txt') <= 0"
    commands:
      - "cp {{ipFile}} {{Output}}/ipspace/{{Workspace}}-noncdn.txt"

post_run:

