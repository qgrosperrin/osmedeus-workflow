name: fingerprint
desc: fingerprint HTTP technology and response

report:
  final:
    - "{{Output}}/fingerprint/{{Workspace}}-technologies.txt"
    - "{{Output}}/fingerprint/beautify-{{Workspace}}-http.txt"
    - "{{Output}}/fingerprint/{{Workspace}}-http-overview.txt"
    - "{{Output}}/fingerprint/{{Workspace}}-ntlm-found.json"
    - "{{Output}}/fingerprint/{{Workspace}}-ntlm-info.txt"

params:
  diffHttpFile: "{{Output}}/probing/diffhttp-{{Workspace}}.txt"
  finThreads: "{{ threads }}"
  overviewThreads: "{{ threads * 5}}"
  httpTimeout: "10"
  httpFile: "{{Output}}/probing/http-{{Workspace}}.txt"
  overviewJsonFile: "{{Output}}/fingerprint/{{Workspace}}-http-overview.txt"
  defaultUA: "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
  ntlmDictFile: "{{Data}}/wordlists/ntlm-paths.dict"

pre_run:
  - CreateFolder("{{Output}}/fingerprint")

steps:
  # 1. Standard HTTP Fingerprinting
  - required:
      - "{{Binaries}}/httpx"
      - "{{httpFile}}"
    commands:
      - cat {{httpFile}} | {{Binaries}}/httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{overviewThreads}} -no-fallback -no-color -silent -json -title -favicon -hash sha256 -jarm -tech-detect -status-code -cdn -tls-grab -ztls -vhost -follow-host-redirects -include-chain >> {{overviewJsonFile}}
    scripts:
      - ExecCmd("echo 'URL, Title, Tech, Response Hash' > {{Output}}/fingerprint/{{Workspace}}-raw-overview.txt")
      - ExecCmd("{{overviewJsonFile}} | {{Binaries}}/json-cleaner -f 'hash.body_sha256,words,lines' > {{diffHttpFile}}")
      - CleanJSONHttpx('{{overviewJsonFile}}', '{{Output}}/fingerprint/{{Workspace}}-raw-overview.txt')
      - BeautifyCSV('{{Output}}/fingerprint/{{Workspace}}-raw-overview.txt', '{{Output}}/fingerprint/beautify-{{Workspace}}-http.txt')
      - Cat("{{Output}}/fingerprint/beautify-{{Workspace}}-http.txt")
      - "Printf('==> The raw result can be found at: {{overviewJsonFile}}')"

  # 2. NTLM Discovery (HTTPX -> JSON)
  - required:
      - "{{Binaries}}/httpx"
      - "{{httpFile}}"
    commands:
      - "cat {{httpFile}} | {{Binaries}}/httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{overviewThreads}} -no-fallback -no-color -silent -json -path {{ntlmDictFile}} -H 'Authorization: NTLM TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=' -ms 'NTLM' -follow-host-redirects -o {{Output}}/fingerprint/{{Workspace}}-ntlm-found.json"
    scripts:
      - "Printf('==> NTLM Endpoints found (JSON): {{Output}}/fingerprint/{{Workspace}}-ntlm-found.json')"

  # 3. NTLM Information Extraction (Strict JQ + Nmap)
  - conditions:
      - FileLength('{{Output}}/fingerprint/{{Workspace}}-ntlm-found.json') > 0
    required:
      - "{{Binaries}}/nmap"
      - "jq"
    commands:
      # DIRECT PARSING: Uses .port and .host directly from JSON. Path is stripped from .url regex.
      - "cat {{Output}}/fingerprint/{{Workspace}}-ntlm-found.json | jq -r '\"nmap -Pn -sT -p\" + .port + \" --script=http-ntlm-info --script-args=http-ntlm-info.root=\\\"\" + (.url | sub(\"^https?://[^/]+\"; \"\")) + \"\\\" \" + .host' | sh >> {{Output}}/fingerprint/{{Workspace}}-ntlm-info.txt"
    scripts:
      - "Printf('==> Nmap NTLM Info saved to: {{Output}}/fingerprint/{{Workspace}}-ntlm-info.txt')"

  # 4. Fallback
  - conditions:
      - FileLength('{{diffHttpFile}}') <= 0
    commands:
      - "cp {{httpFile}} {{diffHttpFile}}"

post_run:
  - TotalTech("{{Output}}/fingerprint/{{Workspace}}-raw-overview.txt")
  - GenMarkdownReport("{{Data}}/markdown/general-template.md", "{{Output}}/summary.html")