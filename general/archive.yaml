name: archive
desc: Finding archive URLs

report:
  final:
    - "{{Output}}/archive/{{Workspace}}-archive.txt"
    - "{{Output}}/archive/{{Workspace}}-interesting.txt"
    - "{{Output}}/archive/{{Workspace}}-archive-table.txt"

params:
  - httpFile: "{{Output}}/probing/http-{{Workspace}}.txt"
  - archiveFile: "{{Output}}/archive/{{Workspace}}-archive.txt"
  - overviewArchiveJsonFile: "{{Output}}/archive/{{Workspace}}-overview-archive.txt"
  - urlfinderConfig: "{{Data}}/external-configs/urlfinder-providers.yaml"
  - archiveTimeout: "1h"
  - alimit: "10000"
  - archiveThreads: "{{ threads / 2 }}"
  - overviewThreads: "{{ threads * 5 }}"
  - defaultUA: "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"  

pre_run:
  - CreateFolder("{{Output}}/archive")

steps:
  # 1. Fetch URLs using urlfinder
  - required:
      - "{{Binaries}}/urlfinder"
    commands:
      - "timeout -k 1m {{archiveTimeout}} {{Binaries}}/urlfinder -d {{Target}} -config {{urlfinderConfig}} -silent -all | {{Binaries}}/durl | shuf -n {{alimit}} >> {{archiveFile}}"
    scripts:
      - "SortU('{{archiveFile}}')"
  
  # 2. Analyze URLs with HTTPX and Generate Reports
  - required:
      - "{{Binaries}}/httpx"
      - "{{archiveFile}}"
    commands:
      - cat {{archiveFile}} | {{Binaries}}/httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{overviewThreads}} -no-fallback -no-color -silent -json -title -status-code -cl -location -follow-host-redirects >> {{overviewArchiveJsonFile}}

    scripts:
      - ExecCmd("cat {{overviewArchiveJsonFile}} | jq -r '[.url, (.status_code|tostring), (.content_length|tostring), (.location // \"\")] | join(\",\")' > {{Output}}/archive/archive-{{Workspace}}.csv")
      - ExecCmd("cat {{Output}}/archive/archive-{{Workspace}}.csv | {{Binaries}}/csvtk cut -f 1,2,3,4 -I | {{Binaries}}/csvtk pretty --no-header-row -I -s ' | ' -W 75 > {{Output}}/archive/{{Workspace}}-archive-table.txt")
      - Cat("{{Output}}/archive/{{Workspace}}-archive-table.txt")
      - "Printf('==> The raw JSON result can be found at: {{overviewArchiveJsonFile}}')"

post_run:
  - TotalArchive('{{archiveFile}}')